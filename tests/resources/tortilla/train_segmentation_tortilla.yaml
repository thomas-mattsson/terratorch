# lightning.pytorch==2.1.1
seed_everything: 0
trainer:
  accelerator: auto
  strategy: auto
  devices: auto
  num_nodes: 1
  #precision: 16-mixed
  logger:
    class_path: TensorBoardLogger
    init_args:
      save_dir: tests/
      name: tortilla_tests
      log_graph: true
      flush_secs: 30
  callbacks:
    - class_path: LearningRateMonitor
      init_args:
        logging_interval: epoch
    - class_path: ModelCheckpoint
      init_args:
        filename: "epoch-{epoch:02d}-val_loss-{val/loss:.4f}"
        monitor: val/loss
        mode: min
        save_top_k: 3
        every_n_epochs: 10
        auto_insert_metric_name: False
  max_epochs: 200
  check_val_every_n_epoch: 1
  log_every_n_steps: 1
  enable_checkpointing: true
  default_root_dir: tests/
  gradient_clip_val: 1.0
  
data:
  class_path: GenericNonGeoSegmentationDataModule
  init_args:
    tortilla_file: tests/resources/tortilla/sampled_dataset.tortilla
    batch_size: 16
    num_workers: 8
    no_data_replace: 0
    no_label_replace: -1
    constant_scale: 1.0
    dataset_bands:
      - BLUE
      - GREEN
      - RED
    output_bands:
      - BLUE
      - GREEN
      - RED
    rgb_indices: [2, 1, 0]
    train_transform:
      - class_path: albumentations.D4
      - class_path: albumentations.pytorch.transforms.ToTensorV2
    means: [239.69607943988473, 541.6962756324797, 343.4131793190031]
    stds: [241.66959758723047, 271.1097433522591, 339.0876427601437]
    num_classes: 2

model:
  class_path: terratorch.tasks.SemanticSegmentationTask 
  init_args:
    model_factory: EncoderDecoderFactory
    model_args:
      backbone: terramind_v1_base
      backbone_pretrained: True
      backbone_modalities: 
        - S2L2A 
       # - S1GRD
      backbone_bands:
        S2L2A: ["BLUE", "GREEN", "RED"]
      necks:
        - name: SelectIndices
          indices: [2, 5, 8, 11] # 100M models
        - name: ReshapeTokensToImage
        - name: LearnedInterpolateToPyramidal
      decoder: UNetDecoder
      decoder_channels: [512, 256, 128, 64]
      head_channel_list: [256]
      head_dropout: 0.2
      num_classes: 2
    loss: dice
    # aux_heads:
    #   - name: aux_head
    #     decoder: FCNDecoder
    #     decoder_args:
    #       decoder_channels: 256
    #       decoder_in_index: -1
    #       decoder_num_convs: 2
    #       head_dropout: 0.1
    aux_loss:
      aux_head: 1.0
    ignore_index: -1
    freeze_backbone: false
    freeze_decoder: false
    tiled_inference_parameters:
      h_crop: 224
      h_stride: 196
      w_crop: 224
      w_stride: 196
      average_patches: true

optimizer:
  class_path: torch.optim.AdamW
  init_args:
    lr: 1.e-5
    weight_decay: 0.2

lr_scheduler:
  class_path: CosineAnnealingWarmRestarts
  init_args:
    T_0: 10
    T_mult: 2
    eta_min: 1e-6

